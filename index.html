<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ROTAM ‚Ä¢ Ocorr√™ncias</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker registrado!"))
        .catch(err => console.error("Erro ao registrar Service Worker", err));
    }
  </script>

  <style>
    :root{
      --bg:#0b0c10; 
      --card:#15171c; 
      --muted:#9aa3af; 
      --text:#e5e7eb; 
      --acc:#7c3aed; 
      --acc2:#22c55e; 
      --danger:#ef4444;
      --warning:#eab308;
      --success:#16a34a;
      --br:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}

    /* Cabe√ßalho */
    header{
      display:flex;justify-content:space-between;align-items:center;
      padding:16px 28px;background:#111318;border-bottom:2px solid #222;
      position:sticky;top:0;z-index:10;
    }
    header h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
    header img{height:32px;border-radius:50%}

    /* Conte√∫do */
    .wrap{max-width:1200px;margin:auto;padding:28px}
    .card{background:var(--card);border-radius:var(--br);padding:18px;box-shadow:0 6px 24px rgba(0,0,0,.24)}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* Form */
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid #262833;
      background:#101116;color:var(--text);outline:none
    }
    textarea{min-height:84px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{
      border:0;padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;
      transition:.15s transform ease;
    }
    button:hover{transform:translateY(-1px)}
    .good{background:var(--acc2)}
    .ghost{background:#30323a}
    .danger{background:var(--danger)}

    /* Tabela */
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:12px;border-bottom:1px solid #262833;vertical-align:middle}
    th{color:#b9c0c9;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
    tr:nth-child(even){background:#1d1f25}
    .pill{
      display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600
    }
    .status-aberto{background:var(--danger);color:#fff}
    .status-andamento{background:var(--warning);color:#000}
    .status-encerrado{background:var(--success);color:#fff}
    .right{display:flex;gap:6px;justify-content:flex-end}
    .empty{padding:18px;border:1px dashed #2b2e36;border-radius:12px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <h1>üöì ROTAM ‚Ä¢ Ocorr√™ncias</h1>
  <span class="muted">Sistema de Registro</span>
</header>

<div class="wrap">
  <div class="grid">
    <!-- Formul√°rio -->
    <section class="card">
      <h3 style="margin:0 0 8px">Nova ocorr√™ncia</h3>
      <form id="form">
        <div class="row">
          <div>
            <label>ID do agente</label>
            <input id="reporter_id" type="number" placeholder="Ex: 1006" />
          </div>
          <div>
            <label>Nome do agente</label>
            <input id="reporter_name" placeholder="Ex: Agente Silva" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Comunicante (nome)</label>
            <input id="comunicante_nome" placeholder="Ex: Maria Santos" />
          </div>
          <div>
            <label>Comunicante RG</label>
            <input id="comunicante_rg" placeholder="Ex: 1234567" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Comunicante CPF</label>
            <input id="comunicante_cpf" placeholder="Somente n√∫meros" />
          </div>
          <div>
            <label>Telefone</label>
            <input id="comunicante_telefone" placeholder="(65) 99999-0000" />
          </div>
        </div>

        <label>Endere√ßo</label>
        <input id="comunicante_endereco" placeholder="Rua, n√∫mero" />

        <div class="row">
          <div>
            <label>Data do fato</label>
            <input id="occurred_at" type="date" />
          </div>
          <div>
            <label>Local do fato</label>
            <input id="occurred_location" placeholder="Ex: Pra√ßa Central" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Tipo de ocorr√™ncia</label>
            <input id="occurrence_type" placeholder="Ex: Furto" />
          </div>
          <div>
            <label>Status</label>
            <select id="status">
              <option>Aberto</option>
              <option>Em andamento</option>
              <option>Encerrado</option>
            </select>
          </div>
        </div>

        <label>Descri√ß√£o</label>
        <textarea id="description" placeholder="Relato resumido..."></textarea>

        <label class="muted">Envolvidos (JSON) ‚Äì ex: [{"nome":"Jo√£o","papel":"v√≠tima"}]</label>
        <textarea id="involved" placeholder='[{"nome":"Jo√£o","papel":"v√≠tima"}]'></textarea>

        <div class="actions">
          <button type="submit" class="good">Cadastrar</button>
          <button type="button" class="ghost" id="reset">Limpar</button>
        </div>
      </form>
    </section>

    <!-- Lista -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 style="margin:0">Ocorr√™ncias</h3>
        <button class="ghost" id="refresh">Recarregar</button>
      </div>
      <div id="list"></div>
    </section>
  </div>
</div>

<script>
  const API = 'https://rotam-backend-production.up.railway.app';

  const els = {
    form: document.getElementById('form'),
    reset: document.getElementById('reset'),
    refresh: document.getElementById('refresh'),
    list: document.getElementById('list'),
    fields: {
      reporter_id: document.getElementById('reporter_id'),
      reporter_name: document.getElementById('reporter_name'),
      comunicante_nome: document.getElementById('comunicante_nome'),
      comunicante_rg: document.getElementById('comunicante_rg'),
      comunicante_cpf: document.getElementById('comunicante_cpf'),
      comunicante_endereco: document.getElementById('comunicante_endereco'),
      comunicante_telefone: document.getElementById('comunicante_telefone'),
      occurred_at: document.getElementById('occurred_at'),
      occurred_location: document.getElementById('occurred_location'),
      occurrence_type: document.getElementById('occurrence_type'),
      description: document.getElementById('description'),
      involved: document.getElementById('involved'),
      status: document.getElementById('status'),
    }
  };

  els.fields.occurred_at.value = new Date().toISOString().slice(0,10);

  async function getAll(){
    els.list.innerHTML = '<div class="empty">Carregando...</div>';
    try{
      const r = await fetch(`${API}/occurrences`);
      const data = await r.json();
      if(!Array.isArray(data) || data.length === 0){
        els.list.innerHTML = '<div class="empty">Nenhuma ocorr√™ncia.</div>';
        return;
      }
      renderTable(data);
    }catch(e){
      els.list.innerHTML = `<div class="empty">Erro: ${e.message}</div>`;
    }
  }

  function renderTable(rows){
    const toCell = v => (v===null||v===undefined||v==='') ? '<span class="muted">‚Äî</span>' : String(v);
    const badge = status => {
      if(status==="Aberto") return `<span class="pill status-aberto">Aberto</span>`;
      if(status==="Em andamento") return `<span class="pill status-andamento">Em andamento</span>`;
      if(status==="Encerrado") return `<span class="pill status-encerrado">Encerrado</span>`;
      return `<span class="pill">${status}</span>`;
    };

    els.list.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Agente</th><th>Comunicante</th><th>Data</th><th>Local</th>
            <th>Tipo</th><th>Status</th><th class="right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(o => `
            <tr>
              <td>${o.id}</td>
              <td><div>${toCell(o.reporter_name)}</div><div class="muted">#${toCell(o.reporter_id)}</div></td>
              <td>${toCell(o.comunicante_nome)}</td>
              <td>${toCell((o.occurred_at||'').slice(0,10))}</td>
              <td>${toCell(o.occurred_location)}</td>
              <td>${toCell(o.occurrence_type)}</td>
              <td>${badge(o.status)}</td>
              <td class="right">
                <button class="ghost" onclick="promptStatus(${o.id}, '${o.status||''}')">‚úèÔ∏è</button>
                <button class="danger" onclick="removeItem(${o.id})">üóëÔ∏è</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  }

  async function create(e){
    e.preventDefault();
    const f = els.fields;
    let involved = [];
    if(f.involved.value.trim()){
      try{ involved = JSON.parse(f.involved.value.trim()); }catch{ alert('Campo "envolvidos" inv√°lido.'); return; }
    }
    const body = {
      reporter_id: numOrNull(f.reporter_id.value),
      reporter_name: emptyToNull(f.reporter_name.value),
      comunicante_nome: emptyToNull(f.comunicante_nome.value),
      comunicante_rg: emptyToNull(f.comunicante_rg.value),
      comunicante_cpf: emptyToNull(f.comunicante_cpf.value),
      comunicante_endereco: emptyToNull(f.comunicante_endereco.value),
      comunicante_telefone: emptyToNull(f.comunicante_telefone.value),
      occurred_at: emptyToNull(f.occurred_at.value),
      occurred_location: emptyToNull(f.occurred_location.value),
      occurrence_type: emptyToNull(f.occurrence_type.value),
      description: emptyToNull(f.description.value),
      involved,
      measures_taken: null,
      signature: null,
      attachments: [],
      status: f.status.value || 'Aberto'
    };
    try{
      const r = await fetch(`${API}/occurrences`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error((await r.json()).error || r.statusText);
      resetForm(); await getAll();
      alert('Ocorr√™ncia criada com sucesso!');
    }catch(e){ alert('Erro ao criar: ' + e.message); }
  }

  async function promptStatus(id, oldStatus){
    const novo = prompt(`Novo status para #${id}`, oldStatus || 'Em andamento');
    if(novo===null) return;
    try{
      const r = await fetch(`${API}/occurrences/${id}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status: novo })
      });
      if(!r.ok) throw new Error((await r.json()).error || r.statusText);
      await getAll();
    }catch(e){ alert('Erro ao atualizar: ' + e.message); }
  }

  async function removeItem(id){
    if(!confirm(`Excluir ocorr√™ncia #${id}?`)) return;
    try{
      const r = await fetch(`${API}/occurrences/${id}`, { method:'DELETE' });
      if(!r.ok) throw new Error((await r.json()).error || r.statusText);
      await getAll();
    }catch(e){ alert('Erro ao excluir: ' + e.message); }
  }

  function resetForm(){
    els.form.reset();
    els.fields.occurred_at.value = new Date().toISOString().slice(0,10);
  }
  function emptyToNull(v){ v = (v||'').trim(); return v ? v : null; }
  function numOrNull(v){ const n = Number((v||'').trim()); return Number.isFinite(n) ? n : null; }

  els.form.addEventListener('submit', create);
  els.reset.addEventListener('click', resetForm);
  els.refresh.addEventListener('click', getAll);
  window.removeItem = removeItem;
  window.promptStatus = promptStatus;
  getAll();
</script>
</body>
</html>
