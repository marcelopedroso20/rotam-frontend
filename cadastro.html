<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro - ROTAM</title>
  <link rel="stylesheet" href="style.css">
  <script>
    // Prote√ß√£o: s√≥ acessa se estiver logado
    if (!localStorage.getItem("user")) {
      window.location.href = "login.html";
    }
  </script>
</head>
<body>
  <!-- ===== MENU SUPERIOR ===== -->
  <header class="menu">
    <div class="logo">üöì ROTAM</div>
    <nav>
      <ul>
        <li><a href="index.html">In√≠cio</a></li>
        <li><a href="cadastro.html" class="active">Cadastro</a></li>
        <li><a href="relatorio.html">Relat√≥rio</a></li>
      </ul>
    </nav>
    <button onclick="logout()">Sair</button>
  </header>

  <!-- ===== CONTE√öDO ===== -->
  <main>
    <h1>Cadastro de Ocorr√™ncia</h1>
    <form id="formCadastro">
      <h2>Dados do Agente</h2>
      <label>ID do agente</label>
      <input type="number" id="reporter_id" placeholder="Ex: 1006" required>

      <label>Nome do agente</label>
      <input type="text" id="reporter_name" placeholder="Ex: Agente Silva" required>

      <h2>Dados do Comunicante</h2>
      <label>Nome</label>
      <input type="text" id="comunicante_nome" placeholder="Ex: Jo√£o da Silva">

      <label>RG</label>
      <input type="text" id="comunicante_rg" placeholder="Ex: 1234567">

      <label>CPF</label>
      <input type="text" id="comunicante_cpf" placeholder="Somente n√∫meros">

      <label>Endere√ßo</label>
      <input type="text" id="comunicante_endereco" placeholder="Rua, n√∫mero">

      <label>Telefone</label>
      <input type="text" id="comunicante_telefone" placeholder="(65) 99999-0000">

      <h2>Ocorr√™ncia</h2>
      <label>Data</label>
      <input type="date" id="occurred_at">

      <label>Local</label>
      <input type="text" id="occurred_location" placeholder="Ex: Pra√ßa Central">

      <label>Tipo</label>
      <input type="text" id="occurrence_type" placeholder="Ex: Furto">

      <label>Status</label>
      <select id="status">
        <option>Aberto</option>
        <option>Em andamento</option>
        <option>Encerrado</option>
      </select>

      <label>Descri√ß√£o</label>
      <textarea id="description" placeholder="Relato resumido..."></textarea>

      <button type="submit">Cadastrar</button>
    </form>
    <p id="msg" class="msg"></p>
  </main>

  <script src="logout.js"></script>
  <script>
    const API = "https://rotam-backend-production.up.railway.app";

    document.getElementById("formCadastro").addEventListener("submit", async (e) => {
      e.preventDefault();
      const body = {
        reporter_id: document.getElementById("reporter_id").value,
        reporter_name: document.getElementById("reporter_name").value,
        comunicante_nome: document.getElementById("comunicante_nome").value,
        comunicante_rg: document.getElementById("comunicante_rg").value,
        comunicante_cpf: document.getElementById("comunicante_cpf").value,
        comunicante_endereco: document.getElementById("comunicante_endereco").value,
        comunicante_telefone: document.getElementById("comunicante_telefone").value,
        occurred_at: document.getElementById("occurred_at").value,
        occurred_location: document.getElementById("occurred_location").value,
        occurrence_type: document.getElementById("occurrence_type").value,
        description: document.getElementById("description").value,
        status: document.getElementById("status").value,
        involved: [],
        measures_taken: "",
        signature: "",
        attachments: []
      };

      try {
        const res = await fetch(`${API}/occurrences`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (res.ok) {
          document.getElementById("msg").textContent = "‚úÖ Ocorr√™ncia cadastrada com sucesso!";
          document.getElementById("formCadastro").reset();
        } else {
          document.getElementById("msg").textContent = "‚ùå Erro: " + (data.error || "Falha desconhecida");
        }
      } catch (err) {
        document.getElementById("msg").textContent = "‚ùå Erro de conex√£o com o servidor.";
      }
    });
  </script>
</body>
</html>
